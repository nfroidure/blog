4:I[5613,[],""]
5:I[1778,[],""]
6:{"fontFamily":"system-ui,\"Segoe UI\",Roboto,Helvetica,Arial,sans-serif,\"Apple Color Emoji\",\"Segoe UI Emoji\"","height":"100vh","textAlign":"center","display":"flex","flexDirection":"column","alignItems":"center","justifyContent":"center"}
7:{"display":"inline-block","margin":"0 20px 0 0","padding":"0 23px 0 0","fontSize":24,"fontWeight":500,"verticalAlign":"top","lineHeight":"49px"}
8:{"display":"inline-block"}
9:{"fontSize":14,"fontWeight":400,"lineHeight":"49px","margin":0}
0:["9fUASsqhclwKyXSiuGa9K",[[["",{"children":["(withRedirects)",{"children":[["locale","articles-design_base_donnee_mongodb","d"],{"children":["__PAGE__?{\"locale\":\"articles-design_base_donnee_mongodb\"}",{}]},"$undefined","$undefined",true]}]}],["",{"children":["(withRedirects)",{"children":[["locale","articles-design_base_donnee_mongodb","d"],{"children":["__PAGE__",{},["$L1","$L2",null]]},[null,"$L3",null]]},["$","$L4",null,{"parallelRouterKey":"children","segmentPath":["children","(withRedirects)","children"],"loading":"$undefined","loadingStyles":"$undefined","loadingScripts":"$undefined","hasLoading":false,"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L5",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":[["$","title",null,{"children":"404: This page could not be found."}],["$","div",null,{"style":{"fontFamily":"system-ui,\"Segoe UI\",Roboto,Helvetica,Arial,sans-serif,\"Apple Color Emoji\",\"Segoe UI Emoji\"","height":"100vh","textAlign":"center","display":"flex","flexDirection":"column","alignItems":"center","justifyContent":"center"},"children":["$","div",null,{"children":[["$","style",null,{"dangerouslySetInnerHTML":{"__html":"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}"}}],["$","h1",null,{"className":"next-error-h1","style":{"display":"inline-block","margin":"0 20px 0 0","padding":"0 23px 0 0","fontSize":24,"fontWeight":500,"verticalAlign":"top","lineHeight":"49px"},"children":"404"}],["$","div",null,{"style":{"display":"inline-block"},"children":["$","h2",null,{"style":{"fontSize":14,"fontWeight":400,"lineHeight":"49px","margin":0},"children":"This page could not be found."}]}]]}]}]],"notFoundStyles":[],"styles":[["$","link","0",{"rel":"stylesheet","href":"https://insertafter.com/_next/static/css/1f9f2e31c0c7b0ad.css","precedence":"next","crossOrigin":""}]]}]]},["$","$L4",null,{"parallelRouterKey":"children","segmentPath":["children"],"loading":"$undefined","loadingStyles":"$undefined","loadingScripts":"$undefined","hasLoading":false,"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L5",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":[["$","title",null,{"children":"404: This page could not be found."}],["$","div",null,{"style":"$6","children":["$","div",null,{"children":[["$","style",null,{"dangerouslySetInnerHTML":{"__html":"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}"}}],["$","h1",null,{"className":"next-error-h1","style":"$7","children":"404"}],["$","div",null,{"style":"$8","children":["$","h2",null,{"style":"$9","children":"This page could not be found."}]}]]}]}]],"notFoundStyles":[],"styles":null}]],[null,"$La"]]]]
b:"$Sreact.strict_mode"
c:I[4630,["176","static/chunks/176-0a03be62efe5672b.js","960","static/chunks/app/(withLocale)/%5Blocale%5D/layout-6f34dfcd57f7d3e4.js"],""]
d:I[4341,["176","static/chunks/176-0a03be62efe5672b.js","960","static/chunks/app/(withLocale)/%5Blocale%5D/layout-6f34dfcd57f7d3e4.js"],""]
e:["locale","articles-design_base_donnee_mongodb","d"]
3:["$","$b",null,{"children":["$","html",null,{"lang":"articles-design_base_donnee_mongodb","children":["$","body",null,{"className":"layout_body__jFZuu","children":[null,["$","header",null,{"className":"header_iaHeader__4vCMA","children":["$","div",null,{"className":"$undefined","children":["$","h1",null,{"children":["$","a",null,{"href":"/articles-design_base_donnee_mongodb","title":"Go back to home page","className":"header_iaHeaderLogo__0uNr1","children":["$","img",null,{"src":"/images/logo.svg","alt":"InsertAfter's Logo"}]}]}]}]}],["$","$Lc",null,{"locale":"articles-design_base_donnee_mongodb","dictionary":{"home":{"label":"Home","title":"Go back to home page"},"blog":{"label":"Blog","title":"Read my blog posts"},"projects":{"label":"Projects","title":"Discover my projects"},"about":{"label":"About me","title":"Read more about me"}}}],["$","$Ld",null,{"locale":"articles-design_base_donnee_mongodb"}],["$","main",null,{"className":"layout_iaMain__6s2gl","children":["$","div",null,{"children":["$","$L4",null,{"parallelRouterKey":"children","segmentPath":["children","(withRedirects)","children","$e","children"],"loading":"$undefined","loadingStyles":"$undefined","loadingScripts":"$undefined","hasLoading":false,"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L5",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined","styles":[["$","link","0",{"rel":"stylesheet","href":"https://insertafter.com/_next/static/css/d44be85332e08038.css","precedence":"next","crossOrigin":""}]]}]}]}],["$","aside",null,{"className":"social_iaSocial__kdR1x","children":["$","nav",null,{"children":["$","ul",null,{"children":[["$","li",null,{"children":["$","a",null,{"href":"https://mastodon.social/@nfroidure","rel":"me","title":"Follow me on Mastodon","className":"social_iaSocialMastodon__MTF6o","children":["$","span",null,{"children":"Mastodon"}]}]}],["$","li",null,{"children":["$","a",null,{"href":"https://bsky.app/profile/nfroidure.bsky.social","rel":"me","title":"Follow me on Bluesky","className":"social_iaSocialBluesky__fKW6M","children":["$","span",null,{"children":"Bluesky"}]}]}],["$","li",null,{"children":["$","a",null,{"href":"https://twitter.com/nfroidure","title":"Follow me on Twitter","className":"social_iaSocialTwitter__9nU6R","children":["$","span",null,{"children":"Twitter"}]}]}],["$","li",null,{"children":["$","a",null,{"href":"https://github.com/nfroidure","title":"See my GitHub projects","className":"social_iaSocialGithub__vcU5_","children":["$","span",null,{"children":"GitHub"}]}]}],["$","li",null,{"children":["$","a",null,{"href":"https://www.npmjs.org/~nfroidure","title":"Check my NPM modules","className":"social_iaSocialNpm__6nku5","children":["$","span",null,{"children":"NPM"}]}]}],["$","li",null,{"children":["$","a",null,{"href":"https://www.linkedin.com/in/nfroidure/","rel":"me","title":"See my LinkedIn profile","className":"social_iaSocialLinkedin__pWACO","children":["$","span",null,{"children":"LinkedIn"}]}]}],["$","li",null,{"children":["$","a",null,{"href":"https://facebook.com/nicolas.froidure.douai","rel":"me","title":"Follow me on Facebook","className":"social_iaSocialFacebook__w4wfH","children":["$","span",null,{"children":"Facebook"}]}]}],["$","li",null,{"children":["$","a",null,{"href":"/articles-design_base_donnee_mongodb/blog/index.atom","title":"Subscribe to my RSS feed","className":"social_iaSocialFeed__gEQQ0","children":["$","span",null,{"children":"RSS Feed"}]}]}]]}]}]}],["$","footer",null,{"className":"footer_iaFooter__rhlnQ","children":["$","p",null,{"className":"footer_iaFooterContent__VZndF","children":["¬© Nicolas Froidure 2012-",2024]}]}]]}]}]}]
f:I[5250,["176","static/chunks/176-0a03be62efe5672b.js","876","static/chunks/876-4c07c683293830f5.js","238","static/chunks/app/(withRedirects)/%5Blocale%5D/page-3351bf05ebb77fa0.js"],""]
2:[["$","section",null,{"className":"contentBlock_root__802UK","children":[[["$","h1",null,{"className":"h1_root__VPXQG","children":[["$","span","0",{"children":"Design de bases de donn√©es MongoDB"}]]}],["$","p",null,{"className":"p_root__SHE_W","children":[["$","span","0",{"children":"Comme nous l'avons vu pr√©c√©demment, la conception de bases de donn√©es avec MongoDB est "}],["$","$Lf",null,{"href":"./retour_xp_mongodb","className":"a_root__WEPS7","title":null,"target":"_self","children":[null,[["$","span","0",{"children":"bien diff√©rente"}]]]}],["$","span","2",{"children":" de la conception avec les bases de donn√©es relationnelles."}]]}],["$","p",null,{"className":"p_root__SHE_W","children":[["$","span","0",{"children":"Dans cet article, je vous propose d'aller un peu plus loin dans les techniques de conception de sch√©ma avec MongoDB. Voici quelques conseils et patterns que j'ai eu √† utiliser pour le backend de l'application SaaS que nous d√©veloppons chez SimpliField."}]]}],["$","h2",null,{"className":"h2_root__Y02lX","children":["$","span",null,{"className":"anchored_root__HWi6K","children":[[["$","span","0",{"children":"Collection¬†!= Mod√®le¬†!= Ressource"}]]," ",["$","small",null,{"children":["$","$Lf",null,{"href":"#collection-modele-ressource","className":"anchored_icon__N5Sem","id":"collection-modele-ressource","title":"Lien vers cette section","children":["$","span",null,{"children":"üîó"}]}]}]]}]}],["$","p",null,{"className":"p_root__SHE_W","children":[["$","span","0",{"children":"Les documents MongoDB sont stock√©s dans des collections. Cette appellation n'est pas innocente. Il faut voir une collection comme un amas de documents pas forc√©ment uniformes et sans aucune corr√©lation avec les concepts que vous manipulez dans vos applications."}]]}],["$","p",null,{"className":"p_root__SHE_W","children":[["$","span","0",{"children":"Ainsi, il ne faut pas chercher √† associer les ressources de votre API REST aux collection MongoDB. Prenons, par exemple, la structure de document suivante¬†:"}]]}],["$","div",null,{"className":"code_root__5JLV_","children":["$","code",null,{"children":["$","pre",null,{"children":"{\n  _id: ObjectId,\n  user: {\n    email: String,\n    name: String\n  },\n  auth: {\n    password: String\n  },\n  preferences: [{\n    name: String,\n    value: String|Boolean|Number\n  }],\n  tags: [{\n    name: String,\n    value: String\n  }],\n  locations_ids: [ObjectId],\n  coworkers_ids: [ObjectId],\n  updates: [{\n    when: Date,\n    by: ObjectId,\n    ip: String\n  }]\n}"}]}]}],["$","p",null,{"className":"p_root__SHE_W","children":[["$","span","0",{"children":"Pour une telle structure, on pourra trouver des points d'API de ce type¬†:"}]]}],["$","ul",null,{"className":"ul_ul__qh0e9","children":[["$","li",null,{"className":"li_root__oY9Dv","children":[["$","p",null,{"className":"p_root__SHE_W","children":[["$","code",null,{"className":"code_root__5JLV_","children":"GET /users"}],["$","span","1",{"children":" - Pour obtenir la liste des utilisateurs ;"}]]}]]}],["$","li",null,{"className":"li_root__oY9Dv","children":[["$","p",null,{"className":"p_root__SHE_W","children":[["$","code",null,{"className":"code_root__5JLV_","children":"POST /users"}],["$","span","1",{"children":" - Pour ajouter un utilisateur ;"}]]}]]}],["$","li",null,{"className":"li_root__oY9Dv","children":[["$","p",null,{"className":"p_root__SHE_W","children":[["$","code",null,{"className":"code_root__5JLV_","children":"GET|PUT /users/:id"}],["$","span","1",{"children":" - Pour lire/√©crire un utilisateur ;"}]]}]]}],["$","li",null,{"className":"li_root__oY9Dv","children":[["$","p",null,{"className":"p_root__SHE_W","children":[["$","code",null,{"className":"code_root__5JLV_","children":"GET|PUT /users/:id/preferences/:name"}],["$","span","1",{"children":" - Pour lire/√©crire une pr√©f√©rence ;"}]]}]]}],["$","li",null,{"className":"li_root__oY9Dv","children":[["$","p",null,{"className":"p_root__SHE_W","children":[["$","code",null,{"className":"code_root__5JLV_","children":"GET|PUT /users/:id/tags"}],["$","span","1",{"children":" - Pour lire/√©crire les tags associ√©s ;"}]]}]]}],["$","li",null,{"className":"li_root__oY9Dv","children":[["$","p",null,{"className":"p_root__SHE_W","children":[["$","code",null,{"className":"code_root__5JLV_","children":"GET|PUT /users/:id/locations"}],["$","span","1",{"children":" - Pour lire/√©diter les lieux de l'utilisateur ;"}]]}]]}],["$","li",null,{"className":"li_root__oY9Dv","children":[["$","p",null,{"className":"p_root__SHE_W","children":[["$","code",null,{"className":"code_root__5JLV_","children":"GET|PUT /users/:id/coworkers"}],["$","span","1",{"children":" - Pour lire/√©diter les coll√®ges de l'utilisateur ;"}]]}]]}]]}],["$","p",null,{"className":"p_root__SHE_W","children":[["$","span","0",{"children":"On voit donc clairement ici le d√©couplage total entre collections et ressources. Ici, on a une collection qui \"contient\" plusieurs ressources, mais dans d'autres cas, on peut avoir une ressource dont le contenu est r√©parti entre plusieurs collections. Ce serait le cas d'une ressource permettant d'acc√©der aux tags associ√©s √† tous les concepts du syst√®me (lieux, utilisateurs, produits...)."}]]}],["$","h2",null,{"className":"h2_root__Y02lX","children":["$","span",null,{"className":"anchored_root__HWi6K","children":[[["$","span","0",{"children":"Pas d'ODM"}]]," ",["$","small",null,{"children":["$","$Lf",null,{"href":"#pas-d-odm","className":"anchored_icon__N5Sem","id":"pas-d-odm","title":"Lien vers cette section","children":["$","span",null,{"children":"üîó"}]}]}]]}]}],["$","p",null,{"className":"p_root__SHE_W","children":[["$","span","0",{"children":"Puisqu'il n'y a aucune corr√©lation entre mod√®les, ressources et collections, je vous d√©conseille fortement l'utilisation d'ODM du type Mongoose. Je ne suis clairement pas fan de ce type d'outils pour les bases de donn√©es relationnelles mais dans le cas de MongoDB, ceci est d'autant plus vrai."}]]}],["$","p",null,{"className":"p_root__SHE_W","children":[["$","span","0",{"children":"Pour tout dire, je l'ai appris dans la douleur. Mongoose a retard√© ma compr√©hension de la philosophie de MongoDB. Qu'on adh√®re ou non √† cette derni√®re, si on utilise MongoDB comme une base de donn√©e relationnelle, alors, on a le pire des deux mondes (et de gros probl√®mes de performances)."}]]}],["$","p",null,{"className":"p_root__SHE_W","children":[["$","span","0",{"children":"Si vous me demandez mon avis sur l'API du driver natif de MongoDB, je vous r√©pondrai qu'il y a une bonne marge d'am√©lioration, mais cette derni√®re est encore le meilleur moyen de profiter de toutes les fonctionnalit√©s qu'un ORM comme Mongoose vous cache."}]]}],["$","p",null,{"className":"p_root__SHE_W","children":[["$","span","0",{"children":"Prenons l'exemple pr√©c√©dent, avec Mongoose, pour mettre √† jour les lieux de l'utilisateur, vous feriez instinctivement ceci¬†:"}]]}],["$","div",null,{"className":"code_root__5JLV_","children":["$","code",null,{"children":["$","pre",null,{"children":"// On s'assure que les ids donn√©s sont corrects\nLocationModel.find(\n  {\n    _id: {\n      $in: myNewLocationsIds,\n    },\n  },\n  function (err, locations) {\n    if (locations.length != myNewLocationsIds.length) {\n      throw new Error(\"Bad locations ids\");\n    }\n    // On met √† jour l'utilisateur\n    UserModel.find(\n      {\n        _id: ObjectId(\"abbacacaabbacacaabbacaca\"),\n      },\n      function (err, user) {\n        user.locations_ids = myNewLocationsIds;\n        user.save();\n      },\n    );\n  },\n);"}]}]}],["$","p",null,{"className":"p_root__SHE_W","children":[["$","span","0",{"children":"Sauf qu'ici, vous r√©cup√©rez toutes les donn√©es des documents pour simplement modifier une propri√©t√© de celle-ci. Ce n'est pas tr√®s optimal et m√™me contraire √† l'esprit de MongoDB. Avec le driver natif, vous √©cririez simplement¬†:"}]]}],["$","div",null,{"className":"code_root__5JLV_","children":["$","code",null,{"children":["$","pre",null,{"children":"// On s'assure que les ids donn√©s sont corrects\ndb.collection(\"location\").count(\n  {\n    _id: {\n      $in: myNewLocationsIds,\n    },\n  },\n  function (err, count) {\n    if (count != myNewLocationsIds.length) {\n      throw new Error(\"Bad locations ids\");\n    }\n    // On met √† jour l'utilisateur\n    UserModel.update(\n      {\n        _id: ObjectId(\"abbacacaabbacacaabbacaca\"),\n      },\n      {\n        $set: {\n          locations_ids: myNewLocationsIds,\n        },\n      },\n      { multi: true },\n    );\n  },\n);"}]}]}],["$","p",null,{"className":"p_root__SHE_W","children":[["$","span","0",{"children":"Certains argumenteront que Mongoose permet tout de m√™me d'utiliser le driver natif, mais c'est moins visible et difficile de r√©exploiter la validation de Mongoose pour ces modifications en dehors de l'API Mongoose."}]]}],["$","p",null,{"className":"p_root__SHE_W","children":[["$","span","0",{"children":"Si vous avez lu mon pr√©c√©dent article sur MongoDB, vous savez que la conception d'une base de donn√©e n√©cessite une r√©flexion au moment de l'impl√©mentation et fonction des principes de MongoDB. Utiliser le driver natif vous garanti de ne pas y √©chapper."}]]}],["$","h2",null,{"className":"h2_root__Y02lX","children":["$","span",null,{"className":"anchored_root__HWi6K","children":[[["$","span","0",{"children":"D√©coupler donn√©es et logique"}]]," ",["$","small",null,{"children":["$","$Lf",null,{"href":"#decoupler-donnees-et-logique","className":"anchored_icon__N5Sem","id":"decoupler-donnees-et-logique","title":"Lien vers cette section","children":["$","span",null,{"children":"üîó"}]}]}]]}]}],["$","p",null,{"className":"p_root__SHE_W","children":[["$","span","0",{"children":"Surtout, une fois d√©barrass√© de Mongoose, ne vous pr√©cipitez pas pour cr√©er votre propre ODM. Il faut consid√©rer le contenu de vos collections comme des donn√©es que vous filtrerez en entr√©e comme en sortie avec des fonctions pures."}]]}],["$","p",null,{"className":"p_root__SHE_W","children":[["$","span","0",{"children":"De cette fa√ßon, vous avez toute libert√© pour utiliser vos fonctions de validation/transformation o√π bon vous semble, quand bon vous semble sans utiliser ces horribles choses que sont l'h√©ritage et les mixins."}]]}],["$","h2",null,{"className":"h2_root__Y02lX","children":["$","span",null,{"className":"anchored_root__HWi6K","children":[[["$","span","0",{"children":"Documents¬†!= Repr√©sentations JSON"}]]," ",["$","small",null,{"children":["$","$Lf",null,{"href":"#documents-representations-json","className":"anchored_icon__N5Sem","id":"documents-representations-json","title":"Lien vers cette section","children":["$","span",null,{"children":"üîó"}]}]}]]}]}],["$","p",null,{"className":"p_root__SHE_W","children":[["$","span","0",{"children":"Une autre erreur √† ne pas commettre est de penser que la structure des documents de votre collection doit √™tre la m√™me que celle des repr√©sentations JSON de votre API REST."}]]}],["$","p",null,{"className":"p_root__SHE_W","children":[["$","span","0",{"children":"En pratique, c'est souvent le contraire. Par exemple, dans la collection utilisateurs ci-dessus, on peut vouloir cr√©er un point d'API qui expose l'utilisateur "}],["$","strong",null,{"className":"strong_root__kOzFq","children":[["$","span","0",{"children":"et"}]]}],["$","span","2",{"children":" ses pr√©f√©rences. On a donc une d√©corr√©lation entre la repr√©sentation d'un utilisateur au niveau de l'API REST et au niveau des documents de la collection MongoDB."}]]}],["$","h2",null,{"className":"h2_root__Y02lX","children":["$","span",null,{"className":"anchored_root__HWi6K","children":[[["$","span","0",{"children":"Rien √† la racine des documents"}]]," ",["$","small",null,{"children":["$","$Lf",null,{"href":"#rien-a-la-racine-des-documents","className":"anchored_icon__N5Sem","id":"rien-a-la-racine-des-documents","title":"Lien vers cette section","children":["$","span",null,{"children":"üîó"}]}]}]]}]}],["$","p",null,{"className":"p_root__SHE_W","children":[["$","span","0",{"children":"Une autre bonne pratique est d'√©viter de stocker des propri√©t√©s d'un m√™me concept √† la racine des documents d'une collection. Par exemple, vous pourriez vous demander pourquoi j'ai cr√©√© une propri√©t√© "}],["$","code",null,{"className":"code_root__5JLV_","children":"user"}],["$","span","2",{"children":" dans laquelle j'ai mis les informations concernant l'utilisateur plut√¥t que de simplement mettre ces propri√©t√©s √† la racine."}]]}],["$","p",null,{"className":"p_root__SHE_W","children":[["$","span","0",{"children":"La raison √† cela est simple. Si un consommateur de l'API fait une requ√™te "}],["$","code",null,{"className":"code_root__5JLV_","children":"PUT"}],["$","span","2",{"children":" vers le point d'API "}],["$","code",null,{"className":"code_root__5JLV_","children":"/users/:id"}],["$","span","4",{"children":", alors, je vais modifier toutes les informations concernant l'utilisateur. Il sera bien plus simple de faire une requ√™te de type "}],["$","code",null,{"className":"code_root__5JLV_","children":"update"}],["$","span","6",{"children":" comme ceci¬†:"}]]}],["$","div",null,{"className":"code_root__5JLV_","children":["$","code",null,{"children":["$","pre",null,{"children":"db.collection(\"users\").update(\n  {\n    _id: userId,\n  },\n  {\n    $set: {\n      user: {\n        name: \"new name\",\n        email: \"new@email.net\",\n      },\n    },\n  },\n  { multi: true },\n);"}]}]}],["$","p",null,{"className":"p_root__SHE_W","children":[["$","span","0",{"children":"Comme vous pouvez le voir une fois encore, nos collections sont taill√©es selon l'usage que nous en faisons."}]]}],["$","h2",null,{"className":"h2_root__Y02lX","children":["$","span",null,{"className":"anchored_root__HWi6K","children":[[["$","span","0",{"children":"Lin√©arisation de l'appartenance"}]]," ",["$","small",null,{"children":["$","$Lf",null,{"href":"#linearisation-de-l-appartenance","className":"anchored_icon__N5Sem","id":"linearisation-de-l-appartenance","title":"Lien vers cette section","children":["$","span",null,{"children":"üîó"}]}]}]]}]}],["$","p",null,{"className":"p_root__SHE_W","children":[["$","span","0",{"children":"On pourrait √™tre tent√© de donner √† nos documents une structure qui refl√®te les relations d'appartenance entre les divers concepts qu'elles rassemblent. Par exemple, les pr√©f√©rences appartenant √† l'utilisateur seraient peut-√™tre mieux dans l'objet utilisateur."}]]}],["$","p",null,{"className":"p_root__SHE_W","children":[["$","span","0",{"children":"C'est clairement une mauvaise id√©e. Toujours pour pouvoir modifier ces concepts simplement, il est g√©n√©ralement pr√©f√©rable de lin√©ariser les concepts au sein des documents."}]]}],["$","p",null,{"className":"p_root__SHE_W","children":[["$","span","0",{"children":"De la m√™me fa√ßon, il est pr√©f√©rable d'aplatir les structures arborescentes dans un unique tableau quitte √† la reconstituer en entr√©e et en sortie de votre API REST."}]]}],["$","p",null,{"className":"p_root__SHE_W","children":[["$","span","0",{"children":"En effet, pour tirer parti des performances des pipes d'agr√©gation, c'est une v√©ritable n√©cessit√©."}]]}],["$","h2",null,{"className":"h2_root__Y02lX","children":["$","span",null,{"className":"anchored_root__HWi6K","children":[[["$","span","0",{"children":"Lazy embedding"}]]," ",["$","small",null,{"children":["$","$Lf",null,{"href":"#lazy-embedding","className":"anchored_icon__N5Sem","id":"lazy-embedding","title":"Lien vers cette section","children":["$","span",null,{"children":"üîó"}]}]}]]}]}],["$","p",null,{"className":"p_root__SHE_W","children":[["$","span","0",{"children":"Comme nous l'avions vu dans mon billet pr√©c√©dent, le point de compression des performances dans une application MongoDB est la gestion des relations inter collections. Puisqu'il n'existe pas de jointure, on fait parfois ce qui s'apparente au d√©sormais bien connu "}],["$","code",null,{"className":"code_root__5JLV_","children":"SELECT"}],["$","span","2",{"children":" dans une boucle honni des DBA."}]]}],["$","p",null,{"className":"p_root__SHE_W","children":[["$","span","0",{"children":"Bien qu'il y aura toujours des cas o√π ce ne sera pas possible de faire autrement, toutes les strat√©gies sont bonnes pour les √©viter. Parmi elles, la technique que j'appelle le lazy embedding permet de stocker ces relations dans les collections afin d'√©viter de les requ√™ter √† chaque acc√®s."}]]}],["$","p",null,{"className":"p_root__SHE_W","children":[["$","span","0",{"children":"Imaginons que nous voulions donner le nom des lieux d'un utilisateur dans la ressource du m√™me nom. Nous devrions effectuer une requ√™te pour aller chercher l'utilisateur, puis, une autre pour aller chercher les noms de ses lieux¬†:"}]]}],["$","div",null,{"className":"code_root__5JLV_","children":["$","code",null,{"children":["$","pre",null,{"children":"db.collection(\"user\").find(\n  {\n    _id: ObjectId(\"abbacacaabbacacaabbacaca\"),\n  },\n  function (err, user) {\n    db.collection(\"locations\").update(\n      {\n        query: {\n          _id: {\n            $in: user.locations_ids,\n          },\n        },\n        fields: [\"_id\", \"location.name\"],\n      },\n      function (err, locations) {\n        user.locations = locations;\n      },\n      { multi: true },\n    );\n  },\n);"}]}]}],["$","p",null,{"className":"p_root__SHE_W","children":[["$","span","0",{"children":"L'id√©e du lazy embedding est de faire cette requ√™te √† la premi√®re demande, d'envoyer le r√©sultat √† l'utilisateur puis de la stocker pour les prochains appels, ce qui donne¬†:"}]]}],["$","div",null,{"className":"code_root__5JLV_","children":["$","code",null,{"children":["$","pre",null,{"children":"db.collection(\"user\").find(\n  {\n    _id: ObjectId(\"abbacacaabbacacaabbacaca\"),\n  },\n  function (err, user) {\n    if (!user.locations) {\n      db.collection(\"locations\").find(\n        {\n          query: {\n            _id: {\n              $in: user.locations_ids,\n            },\n          },\n          fields: [\"_id\", \"location.name\"],\n        },\n        function (err, locations) {\n          user.locations = locations;\n          db.collection(\"user\").update(\n            {\n              _id: ObjectId(\"abbacacaabbacacaabbacaca\"),\n            },\n            {\n              $set: {\n                _locations: locations,\n              },\n            },\n            { multi: true },\n          );\n        },\n      );\n    }\n  },\n);"}]}]}],["$","p",null,{"className":"p_root__SHE_W","children":[["$","span","0",{"children":"Bien entendu, dans les triggers de modification d'un lieu, nous devrons maintenant invalider les utilisateurs concern√©s par ce dernier¬†:"}]]}],["$","div",null,{"className":"code_root__5JLV_","children":["$","code",null,{"children":["$","pre",null,{"children":"db.collection(\"user\").update(\n  {\n    locations_ids: {\n      $elemMatch: modifiedLocationId,\n    },\n  },\n  {\n    $unset: {\n      _locations: \"\",\n    },\n  },\n  { multi: true },\n);"}]}]}],["$","p",null,{"className":"p_root__SHE_W","children":[["$","span","0",{"children":"Forc√©ment, ceci pr√©suppose que vos utilisateurs sont bien plus souvent consult√©s que vos lieux ne sont modifi√©s ce qui est g√©n√©ralement le cas dans la plupart des applications."}]]}],["$","p",null,{"className":"p_root__SHE_W","children":[["$","span","0",{"children":"Dans le cas contraire, gr√¢ce √† la lin√©arisation, il reste possible d'utiliser cette strat√©gie. Par exemple, imaginons que les tags des lieux changent tr√®s souvent, si les documents de la collection lieux sont structur√©s comme nos documents utilisateurs, nous n'aurons pas de probl√®me."}]]}],["$","h2",null,{"className":"h2_root__Y02lX","children":["$","span",null,{"className":"anchored_root__HWi6K","children":[[["$","span","0",{"children":"Listes cap√©es"}]]," ",["$","small",null,{"children":["$","$Lf",null,{"href":"#listes-capees","className":"anchored_icon__N5Sem","id":"listes-capees","title":"Lien vers cette section","children":["$","span",null,{"children":"üîó"}]}]}]]}]}],["$","p",null,{"className":"p_root__SHE_W","children":[["$","span","0",{"children":"Vous avez peut-√™tre remarqu√© la propri√©t√© "}],["$","code",null,{"className":"code_root__5JLV_","children":"updates"}],["$","span","2",{"children":" dans la structure des documents utilisateurs. C'est un tableau dans lequel on stocke les divers updates de l'objet √† des fins de d√©bogage a posteriori."}]]}],["$","p",null,{"className":"p_root__SHE_W","children":[["$","span","0",{"children":"Cependant, il nous faut bien caper ce tableau pour √©viter qu'il ne sature nos documents. On trouve dans les divers op√©rateurs une possibilit√© de r√©aliser ce type d'op√©ration en une seule requ√™te. Ainsi, la modification d'un utilisateur devient¬†:"}]]}],["$","div",null,{"className":"code_root__5JLV_","children":["$","code",null,{"children":["$","pre",null,{"children":"db.collection('users').update({\n  _id: userId\n}, {\n  $set: {\n    'user': {\n      name: 'new name',\n      email: 'new@email.net'\n    }\n  }, {\n    $push : {\n      updates: {\n        $each: [{\n          when: new Date(),\n          by: connectedUserId,\n          ip: connectedUserIp\n        }],\n        $slice: -10\n      }\n    }\n  }\n}, {multi: true});"}]}]}],["$","p",null,{"className":"p_root__SHE_W","children":[["$","span","0",{"children":"Cet exemple montre encore une fois l'int√©r√™t du driver MongoDB natif. Comme il n'existe pas de notion de transaction en Mongo, nous devons tout faire pour limiter la concurrence des requ√™tes et quoi de mieux pour ce faire que de limiter leur nombre¬†?"}]]}],["$","p",null,{"className":"p_root__SHE_W","children":[["$","span","0",{"children":"Il y a encore tellement de techniques dont je n'ai pas parl√©, mais cet article √©tant d√©j√† tr√®s long, je vous d√©voilerai certainement ces derni√®res dans d'autres billets."}]]}],["$","p",null,{"className":"p_root__SHE_W","children":[["$","span","0",{"children":"En attendant, n'h√©sitez pas √† me livrer les v√¥tres en commentaire ou √† donner des alternatives aux techniques que je vous ai pr√©sent√©."}]]}],["$","p",null,{"className":"p_root__SHE_W","children":[["$","span","0",{"children":"Petite pr√©cision, j'ai du faire une modification des sources pr√©sent√©es dans cet article pour ajouter les options "}],["$","code",null,{"className":"code_root__5JLV_","children":"{multi: true}"}],["$","span","2",{"children":" qui permettent aux requ√™tes de mise √† jour de fonctionner sur plusieurs entr√©es. C'est un peu bizarre, mais c'est comme √ßa, par d√©faut les requ√™tes de mise √† jour ne modifient que la premi√®re entr√©e."}]]}],["$","p",null,{"className":"p_root__SHE_W","children":[["$","span","0",{"children":"Je vous propose de monter en abstraction en vous proposant "}],["$","$Lf",null,{"href":"./design_probabiliste_mongodb","className":"a_root__WEPS7","title":null,"target":"_self","children":[null,[["$","span","0",{"children":"ma vision probabiliste de l'utilisation de MongoDB"}]]]}],["$","span","2",{"children":"."}]]}]],["$","p",null,{"className":"p_root__SHE_W","children":["Published at"," ","samedi 28 mars 2015 √† 13:40:32","."]}]]}],["$","section",null,{"className":"contentBlock_root__802UK","children":["$","aside",null,{"className":"share_root__Qm_RR","children":[["$","h2",null,{"className":"h2_root__Y02lX","children":"Commenter et partager"}],["$","p",null,{"className":"p_root__SHE_W","children":[["$","$Lf",null,{"href":"https://www.facebook.com/dialog/share?display=popup&href=https%3A%2F%2Finsertafter.com%2Fblog%2Fdesign_base_donnee_mongodb&redirect_uri=https%3A%2F%2Finsertafter.com","className":"a_root__WEPS7","title":"Commenter sur Facebook","target":"_blank","children":[null,[["$","span",null,{"className":"share_icon__bi4Q3 share_facebook__JKn8d"}],"Facebook"]]}]," - ",["$","$Lf",null,{"href":"https://twitter.com/intent/tweet/?url=https%3A%2F%2Finsertafter.com%2Fblog%2Fdesign_base_donnee_mongodb&text=Design%20de%20bases%20de%20donn%C3%A9es%20MongoDB&via=nfroidure","className":"a_root__WEPS7","title":"Commenter sur Twitter","target":"_blank","children":[null,[["$","span",null,{"className":"share_icon__bi4Q3 "}],"Twitter"]]}]," - ",["$","$Lf",null,{"href":"mailto:nicolas.froidure@gmail.com","className":"a_root__WEPS7","title":"Me r√©pondre par mail","target":"_self","children":[null,[["$","span",null,{"className":"share_icon__bi4Q3 share_mail__yvBDK"}],"Courriel"]]}]]}]]}]}],["$","section",null,{"className":"contentBlock_root__802UK","children":["$","aside",null,{"className":"page_linkedEntries__jiPuT","children":[["$","h2",null,{"className":"h2_root__Y02lX","children":"Articles similaires"}],["$","p",null,{"className":"p_root__SHE_W","children":["Dans les cat√©gories"," ","MongoDB et Base de donn√©es","."]}],["$","div",null,{"className":"items_entries__5hkLG","children":[["$","div","retour_xp_mongodb",{"className":"items_entry_item__GWeg7","children":[null,["$","h2",null,{"className":"h2_root__Y02lX items_entry_title__vJ_8h","children":["$","$Lf",null,{"href":".//retour_xp_mongodb","className":"a_root__WEPS7 items_entry_link__EtVod","title":"Lire cet article de blog","target":"_self","children":[null,"MongoDB : Retour d'exp√©rience"]}]}],["$","p",null,{"className":"p_root__SHE_W items_entry_description__ZWt9y","children":["Je travaille avec MongoDB depuis maintenant presque un an, il est temps pour moi de faire un petit retour sur cette base de donn√©es et sur le NoSQL de mani√®re g√©n√©rale."," ",["$","br",null,{}],["$","$Lf",null,{"href":".//retour_xp_mongodb","className":"a_root__WEPS7","title":"Lire cet article de blog","target":"_self","children":[null,"Lire la suite"]}]]}],["$","p",null,{"className":"p_root__SHE_W items_entry_time__iNrot","children":["Published at"," ","jeudi 4 d√©cembre 2014 √† 20:44:40","."]}],["$","div",null,{"className":"items_clear__3fyGk"}]]}],["$","div","gerer_monnaies_logiciel",{"className":"items_entry_item__GWeg7","children":[null,["$","h2",null,{"className":"h2_root__Y02lX items_entry_title__vJ_8h","children":["$","$Lf",null,{"href":".//gerer_monnaies_logiciel","className":"a_root__WEPS7 items_entry_link__EtVod","title":"Lire cet article de blog","target":"_self","children":[null,"G√©rer les monnaies dans un logiciel (CRM,ERP)"]}]}],["$","p",null,{"className":"p_root__SHE_W items_entry_description__ZWt9y","children":["Je suis actuellement entrain de d√©velopper une solution CRM bas√©e sur mon framework Rest PHP. Il faut donc g√©rer les diff√©rentes monnaies."," ",["$","br",null,{}],["$","$Lf",null,{"href":".//gerer_monnaies_logiciel","className":"a_root__WEPS7","title":"Lire cet article de blog","target":"_self","children":[null,"Lire la suite"]}]]}],["$","p",null,{"className":"p_root__SHE_W items_entry_time__iNrot","children":["Published at"," ","vendredi 16 novembre 2012 √† 10:24:57","."]}],["$","div",null,{"className":"items_clear__3fyGk"}]]}],["$","div","champs_set_et_group_by",{"className":"items_entry_item__GWeg7","children":[null,["$","h2",null,{"className":"h2_root__Y02lX items_entry_title__vJ_8h","children":["$","$Lf",null,{"href":".//champs_set_et_group_by","className":"a_root__WEPS7 items_entry_link__EtVod","title":"Lire cet article de blog","target":"_self","children":[null,"Les champs SET et les requ√™tes GROUP BY"]}]}],["$","p",null,{"className":"p_root__SHE_W items_entry_description__ZWt9y","children":["J'adore utiliser les champs de type SET pour leur souplesse et leur nature multivalu√©es, mais quand GROUP BY entre dans la place, attention les d√©g√¢ts¬†!"," ",["$","br",null,{}],["$","$Lf",null,{"href":".//champs_set_et_group_by","className":"a_root__WEPS7","title":"Lire cet article de blog","target":"_self","children":[null,"Lire la suite"]}]]}],["$","p",null,{"className":"p_root__SHE_W items_entry_time__iNrot","children":["Published at"," ","mardi 28 ao√ªt 2012 √† 09:34:25","."]}],["$","div",null,{"className":"items_clear__3fyGk"}]]}]]}]]}]}]]
a:[["$","meta","0",{"name":"viewport","content":"width=device-width, initial-scale=1"}],["$","meta","1",{"name":"theme-color","content":"#3e78b2"}],["$","meta","2",{"charSet":"utf-8"}],["$","title","3",{"children":"Design de bases de donn√©es MongoDB - Nicolas Froidure"}],["$","meta","4",{"name":"description","content":"Le design de bases de donn√©es MongoDB est une activit√© complexe qui n√©cessite d'avoir une profonde connaissance des implications des divers choix possibles."}],["$","link","5",{"rel":"author","href":"https://insertafter.com"}],["$","meta","6",{"name":"author","content":"Nicolas Froidure"}],["$","meta","7",{"name":"robots","content":"index, follow"}],["$","link","8",{"rel":"canonical","href":"https://insertafter.com/fr/blog/design_base_donnee_mongodb"}],["$","meta","9",{"property":"og:title","content":"Design de bases de donn√©es MongoDB - Nicolas Froidure"}],["$","meta","10",{"property":"og:description","content":"Le design de bases de donn√©es MongoDB est une activit√© complexe qui n√©cessite d'avoir une profonde connaissance des implications des divers choix possibles."}],["$","meta","11",{"property":"og:url","content":"https://insertafter.com/fr/blog/design_base_donnee_mongodb"}],["$","meta","12",{"property":"og:site_name","content":"Nicolas Froidure"}],["$","meta","13",{"property":"og:locale","content":"fr_FR"}],["$","meta","14",{"property":"og:image:alt","content":"Banni√®re du site"}],["$","meta","15",{"property":"og:image","content":"https://insertafter.com/images/banner.png"}],["$","meta","16",{"property":"og:type","content":"article"}],["$","meta","17",{"name":"twitter:card","content":"summary"}],["$","meta","18",{"name":"twitter:site","content":"@nfroidure"}],["$","meta","19",{"name":"twitter:creator","content":"@nfroidure"}],["$","meta","20",{"name":"twitter:title","content":"Design de bases de donn√©es MongoDB - Nicolas Froidure"}],["$","meta","21",{"name":"twitter:description","content":"Le design de bases de donn√©es MongoDB est une activit√© complexe qui n√©cessite d'avoir une profonde connaissance des implications des divers choix possibles."}],["$","meta","22",{"name":"twitter:image:alt","content":"Banni√®re du site"}],["$","meta","23",{"name":"twitter:image","content":"https://insertafter.com/images/banner.png"}],["$","link","24",{"rel":"icon","href":"/images/favicon.svg","type":"image/svg+xml","sizes":"any"}],["$","link","25",{"rel":"icon","href":"/images/favicon-16.png","type":"image/png","sizes":"16x16"}],["$","link","26",{"rel":"icon","href":"/images/favicon-128.png","type":"image/png","sizes":"128x128"}]]
1:null
